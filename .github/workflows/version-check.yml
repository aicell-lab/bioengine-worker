name: Enforce Version Update

on:
  workflow_dispatch:
    inputs:
      pr_branch:
        description: 'Branch to check'
        required: true
  pull_request:
    branches:
      - main

jobs:
  check-version:
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.draft == false
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code (pull_request)
      if: github.event_name == 'pull_request'
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch full history for accurate origin/main reference

    - name: Checkout code (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.pr_branch }}
        fetch-depth: 0  # Fetch full history for accurate origin/main reference

    - name: Determine if relevant files changed
      id: changes
      run: |
        # Ensure we have the base branch
        git fetch origin main --quiet

        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          BASE_SHA="origin/main"
          HEAD_SHA="HEAD"
        fi

        echo "Comparing $BASE_SHA...$HEAD_SHA"
        CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")
        echo "Changed files:" && echo "$CHANGED_FILES" | sed 's/^/ - /'

        # Match original path filters
        if echo "$CHANGED_FILES" | grep -E '^(bioengine/|requirements[^/]*\.txt$|pyproject\.toml$|Dockerfile$|\.dockerignore$)' >/dev/null; then
          echo "RELEVANT_CHANGE=true" >> $GITHUB_ENV
          echo "relevant=true" >> $GITHUB_OUTPUT
          echo "Relevant changes detected; version check will run."
        else
          echo "RELEVANT_CHANGE=false" >> $GITHUB_ENV
          echo "relevant=false" >> $GITHUB_OUTPUT
          echo "No relevant changes detected; version check will be skipped."
        fi

    - name: Extract new version from pyproject.toml (PR branch)
      if: env.RELEVANT_CHANGE == 'true'
      run: |
        NEW_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*"(.*)"/\1/')
        if [ -z "$NEW_VERSION" ]; then
          echo "‚ùå Could not extract version from pyproject.toml in PR branch"
          exit 1
        fi
        echo "üì¶ Extracted new version: $NEW_VERSION"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

    - name: Extract old version from origin/main branch
      if: env.RELEVANT_CHANGE == 'true'
      run: |
        PREVIOUS_VERSION=$(git show origin/main:pyproject.toml | grep -E '^version\s*=' | sed -E 's/version\s*=\s*"(.*)"/\1/')
        if [ -z "$PREVIOUS_VERSION" ]; then
          echo "‚ùå Could not extract version from pyproject.toml on origin/main"
          exit 1
        fi
        echo "üì¶ Extracted previous version: $PREVIOUS_VERSION"
        echo "PREVIOUS_VERSION=$PREVIOUS_VERSION" >> $GITHUB_ENV

    - name: Ensure new version is greater than previous
      if: env.RELEVANT_CHANGE == 'true'
      run: |
        echo "üì¶ Previous version: $PREVIOUS_VERSION"
        echo "üì¶ New version: $NEW_VERSION"
        if [ "$NEW_VERSION" = "$PREVIOUS_VERSION" ]; then
          echo "‚ùå Version has not been updated. Please bump the version in pyproject.toml."
          exit 1
        fi
        if [ "$(printf '%s\n' "$PREVIOUS_VERSION" "$NEW_VERSION" | sort -V | head -n1)" = "$NEW_VERSION" ]; then
          echo "‚ùå New version ($NEW_VERSION) is not greater than previous version ($PREVIOUS_VERSION)."
          exit 1
        fi
        echo "‚úÖ Version updated from $PREVIOUS_VERSION to $NEW_VERSION."

    - name: Skip version check (no relevant changes)
      if: env.RELEVANT_CHANGE == 'false'
      run: echo "‚úÖ No relevant files changed. Skipping version check."


