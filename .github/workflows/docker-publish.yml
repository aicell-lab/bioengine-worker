name: Build and Publish Docker Image

on:
  push:
    branches:
      - main
    paths:
      - 'bioengine/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'Dockerfile'
      - '.dockerignore'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Extract current version from pyproject.toml
      run: |
        VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*"(.*)"/\1/')
        if [ -z "$VERSION" ]; then
          echo "‚ùå Could not extract version from pyproject.toml"
          exit 1
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get latest version from container registry
      run: |
        if ! command -v skopeo &> /dev/null; then
            echo "skopeo could not be found, installing..."
            sudo apt-get update && sudo apt-get install -y skopeo
        fi

        IMAGE="docker://ghcr.io/${{ github.repository }}"
        echo "üîç Fetching tags for $IMAGE..."
        
        if ! skopeo list-tags "$IMAGE" > /dev/null 2>&1; then
           echo "‚ùå Image not found or no tags. Cannot determine previous version."
           exit 1
        fi

        TAGS=$(skopeo list-tags "$IMAGE" | jq -r '.Tags[]')
        
        # Filter out 'latest' and sort by version
        LATEST_VERSION=$(echo "$TAGS" | grep -v "latest" | sort -V | tail -n1)
        
        if [ -z "$LATEST_VERSION" ]; then
           echo "‚ùå No valid version tags found."
           exit 1
        fi
        
        echo "üì¶ Latest registry version: $LATEST_VERSION"
        echo "PREVIOUS_VERSION=$LATEST_VERSION" >> $GITHUB_ENV

    - name: Check that version is updated and newer
      run: |
        echo "üì¶ Previous version: $PREVIOUS_VERSION"
        echo "üì¶ Current version:  $VERSION"
        if [ "$VERSION" = "$PREVIOUS_VERSION" ]; then
          echo "‚ùå Version has not been updated. Please bump the version in pyproject.toml."
          exit 1
        fi
        if [ "$(printf '%s\n' "$PREVIOUS_VERSION" "$VERSION" | sort -V | head -n1)" = "$VERSION" ]; then
          echo "‚ùå New version ($VERSION) is not greater than previous version ($PREVIOUS_VERSION)."
          exit 1
        fi
        echo "‚úÖ Version updated correctly."

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ env.VERSION }}
        labels: |
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
